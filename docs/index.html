<div id="o-uae-form"></div>

{% raw %}
<script>
(function(){
  const mount = document.getElementById('o-uae-form');
  let root; try { root = mount.attachShadow({mode:'open'}); } catch(e){ root = mount; }

  /* ================== DATA ================== */
  const PRODUCTS = [
    { id:'6x150_B500', title:'6×150 mm (B500)', priceAED:960, unitsPerBox:8000, boxesPerPallet:36, lengthMM:150, shipNote:'Available from 1 Dec — ships then' },
    { id:'6x200_B500', title:'6×200 mm (B500)', priceAED:780, unitsPerBox:6000, boxesPerPallet:36, lengthMM:200, shipNote:'Available from 1 Dec — ships then' },
    { id:'8x150_B500', title:'8×150 mm (B500)', priceAED:650, unitsPerBox:5000, boxesPerPallet:32, lengthMM:150, shipNote:'Available from 1 Dec — ships then' },
    { id:'8x200_B500', title:'8×200 mm (B500)', priceAED:490, unitsPerBox:3500, boxesPerPallet:32, lengthMM:200 },
    { id:'8x230_B500', title:'8×230 mm (B500)', priceAED:525, unitsPerBox:3200, boxesPerPallet:32, lengthMM:230 },
    { id:'10x230_B250',title:'10×230 mm (B250)', priceAED:360, unitsPerBox:2000, boxesPerPallet:32, lengthMM:230, shipNote:'Available from 1 Dec — ships then' },

    /* HoReCa Paper Wrapped (available 1 Dec) */
    { id:'OSR_8x230_B250_WP', title:'HoReCa Paper Wrapped — OSR 8×230 B250 WP', priceAED:0, unitsPerBox:2000, boxesPerPallet:32, lengthMM:230, shipNote:'Available from 1 Dec — ships then', horeca:true },

    /* Retail (Dispenser) — adjust boxesPerPallet here if your sheet changes */
    { id:'OSN_6x200_D50', title:'Retail — OSN 6×200 D50', priceAED:0, unitsPerBox:50,  boxesPerPallet:200, lengthMM:200, shipNote:'Available from 1 Dec — ships then', retail:true },
    { id:'OSN_8x200_D30', title:'Retail — OSN 8×200 D30', priceAED:0, unitsPerBox:30,  boxesPerPallet:240, lengthMM:200, shipNote:'Available from 1 Dec — ships then', retail:true },
    { id:'OSB_6x200_D50', title:'Retail — OSB 6×200 D50', priceAED:0, unitsPerBox:50,  boxesPerPallet:200, lengthMM:200, shipNote:'Available from 1 Dec — ships then', retail:true },
    { id:'OSB_8x200_D30', title:'Retail — OSB 8×200 D30', priceAED:0, unitsPerBox:30,  boxesPerPallet:240, lengthMM:200, shipNote:'Available from 1 Dec — ships then', retail:true }
  ];
  const COLORS = ['Nature','Black'];
  const SURCHARGE = { wrap:0.02, logo:0.01 };
  const MOQ_PALLETS_FOR_LOGO = 3;

  /* >>> Hard-wired webhook per your latest URL <<< */
  const WEBHOOK_URL = 'https://services.leadconnectorhq.com/hooks/dVdmanBYF90Y8ezmaUJW/webhook-trigger/80e29f97-0dcb-4772-9e8a-9583a4198dc3';

  /* ================== STYLE ================== */
  const style = document.createElement('style');
  style.textContent = `
  @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800;900&display=swap');
  *{box-sizing:border-box}
  .o-container{font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#0e1525;background:transparent;width:100%;overflow-x:hidden}
  .o-wrap{max-width:1200px;margin:24px auto;padding:24px 16px}
  @media(min-width:960px){.o-wrap{padding:32px}}

  .o-pills{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 16px}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#f1f5f9;border:1px solid #e6ecf3;font-weight:700;font-size:12px;color:#0e1525}
  .pill .flag{width:18px;height:12px;border-radius:2px;background:linear-gradient(90deg,#00732F 0 33.3%,#fff 33.3% 66.6%,#CE1126 66.6% 100%)}
  .o-h1{margin:0 0 6px;font-size:26px;font-weight:900;letter-spacing:.2px}
  @media(min-width:960px){.o-h1{font-size:30px}}
  .o-sub{margin:0 0 12px;color:#334155}

  /* layout: products left, form right on desktop */
  .o-row{display:grid;grid-template-columns:minmax(0,1.1fr) minmax(320px,.9fr);gap:24px;align-items:start}
  @media(max-width:1180px){.o-row{grid-template-columns:1fr}} /* form goes below on mobile */

  .o-grid{display:grid;grid-template-columns:repeat(3,minmax(260px,1fr));gap:16px}
  @media(max-width:1120px){.o-grid{grid-template-columns:repeat(2,minmax(260px,1fr))}}
  @media(max-width:680px){.o-grid{grid-template-columns:1fr}}

  .o-card{background:#fff;border:2px solid #e6ecf3;border-radius:20px;padding:16px;box-shadow:0 10px 24px rgba(18,38,63,.06);transition:.2s;border-color,.2s box-shadow;overflow:visible}
  .o-card.active{border-color:#327A91; box-shadow:0 0 0 3px rgba(50,122,145,.12), 0 14px 30px rgba(18,38,63,.10)}
  .o-title{margin:0 0 4px;font-weight:800;font-size:18px;color:#0c1323}
  .o-muted{font-size:12px;color:#62708c}
  .o-price{margin:10px 0 8px;font-weight:900;color:#327A91}
  .o-ship{display:inline-block;margin-bottom:8px;padding:4px 8px;border-radius:999px;background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;font-weight:700;font-size:12px}

  .o-subcard{border:1px solid #e6ecf3;border-radius:14px;padding:12px;margin-top:12px}
  .o-subhead{display:flex;align-items:center;gap:8px;margin:0 0 6px;font-weight:800}
  .o-dot{width:10px;height:10px;border-radius:999px;border:1px solid #cbd6e2}
  .o-dot.nature{background:#c8b091}
  .o-dot.black{background:#111}

  .o-opt{display:flex;gap:16px;align-items:flex-start;margin:8px 0 4px;flex-wrap:wrap}
  .o-opt label{display:flex;gap:8px;align-items:flex-start;font-size:13px}
  .o-opt input[type=checkbox]{width:16px;height:16px;accent-color:#327A91}
  .o-warn{color:#d92d20;font-size:12px;margin:4px 0 0}
  .o-warn.pop{animation:o-pop .35s ease-out}
  @keyframes o-pop{0%{transform:scale(.98);opacity:.6}60%{transform:scale(1.02);opacity:1}100%{transform:scale(1)}}

  .qtyrow{display:flex;align-items:center;gap:12px;margin-top:8px;white-space:nowrap}
  .qtylabel{flex:0 0 140px;min-width:140px;color:#6b778c;font-size:12px}
  .step{display:flex;align-items:center;gap:10px;flex:0 0 auto}
  .btn{width:36px;height:36px;flex:0 0 36px;border-radius:999px;border:1px solid #e6ecf3;background:#f4f7fb;font-weight:800;font-size:18px;line-height:1;display:flex;align-items:center;justify-content:center;cursor:pointer;user-select:none}
  .btn:focus-visible{outline:2px solid rgba(50,122,145,.35)}
  .val{min-width:56px;height:40px;padding:0 12px;display:flex;align-items:center;justify-content:center;border-radius:999px;border:2px solid #327A91;background:#f3fafc;font-weight:900;font-variant-numeric:tabular-nums;letter-spacing:.2px;font-size:16px}
  .val.pulse{animation:o-pulse .12s ease-out}
  @keyframes o-pulse{0%{transform:scale(1)}50%{transform:scale(1.06)}100%{transform:scale(1)}}
  @media(max-width:480px){
    .qtyrow{flex-wrap:wrap}
    .qtylabel{flex:1 1 100%;min-width:0;margin-bottom:4px}
    .step{gap:8px}
  }

  /* RIGHT COLUMN (sticky) */
  .o-side{background:#fff;border:1px solid #e8eef5;border-radius:22px;padding:18px;box-shadow:0 14px 30px rgba(18,38,63,.08);position:sticky;top:16px}
  .o-line{display:flex;justify-content:space-between;align-items:center;font-size:14px;margin:6px 0}
  .o-total{font-size:18px;font-weight:900}
  .o-div{height:1px;background:#e6ecf3;margin:10px 0}
  .o-badge{display:inline-block;padding:4px 8px;border-radius:999px;background:rgba(50,122,145,.12);color:#1e5f70;font-weight:700;font-size:12px}

  .o-field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
  .o-label{font-size:13px;color:#6b778c}
  .o-input,.o-select,.o-textarea{background:#fff;color:#0c1323;border:1px solid #dbe5ee;border-radius:12px;padding:12px;font:inherit}
  .o-input:focus,.o-select:focus,.o-textarea:focus{outline:none;box-shadow:0 0 0 4px rgba(50,122,145,.18);border-color:rgba(50,122,145,.5)}
  .o-submit{width:100%;padding:14px;border-radius:14px;border:0;cursor:pointer;font-weight:900;background:linear-gradient(135deg,#489bb2,#327A91);color:#fff;box-shadow:0 10px 18px rgba(50,122,145,.18)}
  .o-hidden{display:none}

  /* order summary list in sidebar */
  .sum-list{margin:8px 0 6px;padding:0;list-style:none;max-height:220px;overflow:auto}
  .sum-item{display:flex;gap:8px;align-items:flex-start;padding:6px 0;border-bottom:1px dashed #e6ecf3}
  .sum-chip{display:inline-flex;gap:6px;align-items:center;padding:2px 8px;border-radius:999px;background:#f1f5f9;border:1px solid #e6ecf3;font-size:11px}
  `;

  /* ================== STATE ================== */
  const cart = {};
  COLORS.forEach(c=>{
    PRODUCTS.forEach(p=>{
      cart[p.id] ??= {}; cart[p.id][c] = { boxes:0, pallets:0, wrap:false, logo:false };
    });
  });

  const clamp = (v, lo, hi)=>Math.max(lo, Math.min(hi, v|0));
  const fmtAED = (n)=>`AED ${n.toLocaleString('en-AE',{maximumFractionDigits:0})}`;
  const floor = Math.floor;

  function logoAllowed(p, color){
    if(p.lengthMM === 150) return false;
    const need = (p.boxesPerPallet||0) * MOQ_PALLETS_FOR_LOGO;
    return cart[p.id][color].boxes >= need;
  }
  function logoRemaining(p, color){
    const need = (p.boxesPerPallet||0) * MOQ_PALLETS_FOR_LOGO;
    const have = cart[p.id][color].boxes;
    const rem = Math.max(0, need - have);
    return { rem, palletsApprox: (p.boxesPerPallet? Math.ceil(rem/(p.boxesPerPallet)):0) };
  }

  function syncFromBoxes(p,color){
    const st = cart[p.id][color];
    st.boxes = clamp(st.boxes, 0, 999);
    st.pallets = (p.boxesPerPallet? floor(st.boxes / p.boxesPerPallet) : 0);
  }
  function syncFromPallets(p,color){
    const st = cart[p.id][color];
    const maxPal = (p.boxesPerPallet? floor(999 / p.boxesPerPallet) : 0);
    st.pallets = clamp(st.pallets, 0, maxPal);
    if(p.boxesPerPallet) st.boxes = st.pallets * p.boxesPerPallet;
  }

  function surchargeFor(p,color){
    const st = cart[p.id][color];
    const units = p.unitsPerBox||0;
    let perStraw = 0;
    if(st.wrap && p.lengthMM!==150) perStraw += SURCHARGE.wrap;
    if(st.logo && logoAllowed(p,color)) perStraw += SURCHARGE.logo;
    return perStraw * units * st.boxes;
  }

  function totals(){
    let boxes=0, sum=0;
    PRODUCTS.forEach(p=>COLORS.forEach(c=>{
      const st = cart[p.id][c];
      boxes += st.boxes;
      sum += (st.boxes * p.priceAED) + surchargeFor(p,c);
    }));
    return { boxes, sum };
  }

  /* ================== UI ================== */
  const container = document.createElement('div');
  container.className = 'o-container';
  container.innerHTML = `
    <div class="o-wrap">
      <div class="o-pills">
        <span class="pill"><span class="flag"></span> Ships from Dubai</span>
        <span class="pill">Currency: AED</span>
        <span class="pill">+5% VAT</span>
      </div>
      <h2 class="o-h1">UAE Wholesale Order – UAE Warehouse</h2>
      <p class="o-sub">For HoReCa and Distributors • Prices in AED + 5% VAT</p>
      <ul class="o-sub" style="margin:0 0 12px 18px">
        <li>Optional: Paper Wrapping (+0.02 AED/straw)</li>
        <li>Optional: Custom Logo (+0.01 AED/straw, MOQ 3 pallets)</li>
      </ul>
      <p class="o-sub" style="margin-bottom:18px">Volume discounts (if applicable) will be applied automatically and shown in your order confirmation email.<br><b>Get started easily</b> — place your order through this order portal today!</p>

      <div class="o-row">
        <!-- PRODUCTS LEFT -->
        <div>
          <div class="o-grid" id="grid"></div>
        </div>

        <!-- ORDER FORM RIGHT -->
        <aside class="o-side">
          <div class="o-line"><div>Subtotal</div><div id="subtotal">AED 0</div></div>
          <div class="o-line"><div>Items (boxes)</div><div id="items">0</div></div>
          <div class="o-div"></div>

          <!-- Live order summary -->
          <div class="o-line" style="font-weight:800;margin:4px 0 0">Order summary</div>
          <ul id="sumList" class="sum-list"></ul>
          <div class="o-div"></div>

          <div class="o-line o-total"><div>Total</div><div id="total">AED 0</div></div>
          <div class="o-div"></div>

          <div class="o-field"><label class="o-label">Full name</label><input class="o-input" id="f_name" placeholder="Full name"></div>
          <div class="o-field"><label class="o-label">Email</label><input class="o-input" id="f_email" placeholder="name@company.com"></div>
          <div class="o-field"><label class="o-label">WhatsApp (optional)</label><input class="o-input" id="f_whatsapp" placeholder="9715XXXXXXXX"></div>
          <div class="o-field"><label class="o-label">Company</label><input class="o-input" id="f_company" placeholder="Company name"></div>

          <div class="o-field"><label class="o-label">Delivery Address (Dubai)</label><input class="o-input" id="f_address" placeholder="Street, building, apt/floor"></div>
          <div class="o-field"><label class="o-label">District</label>
            <select class="o-select" id="f_district">
              <option value="">Select area</option><option>Dubai Marina</option><option>JLT</option><option>Business Bay</option><option>Jebel Ali</option><option>Deira</option><option>Other</option>
            </select>
          </div>

          <div class="o-field"><label class="o-label"><input type="checkbox" id="f_diff" style="margin-right:8px"> Deliver to a different recipient & address</label></div>
          <div id="diffWrap" class="o-hidden">
            <div class="o-field"><label class="o-label">Recipient name</label><input class="o-input" id="d_name" placeholder="Recipient full name"></div>
            <div class="o-field"><label class="o-label">Recipient phone</label><input class="o-input" id="d_phone" placeholder="9715XXXXXXXX"></div>
            <div class="o-field"><label class="o-label">Recipient company (optional)</label><input class="o-input" id="d_company" placeholder="Company"></div>
            <div class="o-field"><label class="o-label">Recipient address</label><input class="o-input" id="d_address" placeholder="Street, building, apt/floor"></div>
            <div class="o-field"><label class="o-label">Recipient district</label><input class="o-input" id="d_district" placeholder="Area / district"></div>
          </div>

          <div class="o-field"><label class="o-label">Shipping</label>
            <select class="o-select" id="f_shipping">
              <option value="pickup">Pick up (Dubai warehouse)</option>
              <option value="delivery">Delivery</option>
            </select>
          </div>

          <div class="o-field"><label class="o-label">Message (optional)</label>
            <textarea class="o-textarea" id="f_msg" placeholder="Notes, PO number, timing, etc."></textarea>
          </div>

          <button class="o-submit" id="submitBtn">Submit Order</button>
          <div id="formErr" class="o-warn" style="display:none;margin-top:8px"></div>
          <div id="sentOk" class="o-badge" style="display:none;margin-top:8px">Order submitted</div>
        </aside>
      </div>
    </div>
  `;

  function makeStepper(initial, onChange){
    const wrap = document.createElement('div');
    wrap.className = 'step';
    const minus = document.createElement('button'); minus.className='btn'; minus.type='button'; minus.textContent='–';
    const val = document.createElement('div'); val.className='val'; val.textContent=initial;
    const plus = document.createElement('button'); plus.className='btn'; plus.type='button'; plus.textContent='+';
    const pulse=()=>{ val.classList.add('pulse'); setTimeout(()=>val.classList.remove('pulse'),130); };
    minus.addEventListener('click',()=>onChange(-1,(n)=>{val.textContent=n; pulse();}));
    plus.addEventListener('click',()=>onChange(+1,(n)=>{val.textContent=n; pulse();}));
    wrap.append(minus,val,plus);
    return { el:wrap, set:(n)=>val.textContent=n };
  }

  function renderProducts(){
    const grid = container.querySelector('#grid');
    grid.innerHTML = '';

    PRODUCTS.forEach(p=>{
      const card = document.createElement('div');
      card.className = 'o-card';
      card.dataset.pid = p.id;

      card.innerHTML = `
        <h3 class="o-title">${p.title}</h3>
        <div class="o-muted">
          <div>Per box: ${ (p.unitsPerBox||0).toLocaleString() } straws</div>
          ${ p.boxesPerPallet ? `<div>Per pallet: ${ ((p.unitsPerBox||0)*(p.boxesPerPallet||0)).toLocaleString() } straws — <b>${p.boxesPerPallet}</b> boxes</div>` : '' }
        </div>
        <div class="o-price">${fmtAED(p.priceAED)} <span class="o-muted">/ box</span></div>
        ${ p.shipNote ? `<span class="o-ship">${p.shipNote}</span>` : '' }
      `;

      COLORS.forEach(color=>{
        const st = cart[p.id][color];
        const sub = document.createElement('div');
        sub.className = 'o-subcard';

        const dot = (color==='Nature') ? 'nature' : 'black';
        const subHead = document.createElement('div');
        subHead.className='o-subhead';
        subHead.innerHTML = `<div class="o-dot ${dot}"></div><div style="font-weight:800">${color}</div>`;
        sub.appendChild(subHead);

        const opt = document.createElement('div'); opt.className='o-opt';

        const wrapDisabled = (p.lengthMM===150);
        const logoHard = (p.lengthMM===150);

        const wrapLbl = document.createElement('label');
        wrapLbl.innerHTML = `<input type="checkbox" ${wrapDisabled?'disabled':''} ${st.wrap?'checked':''}> <div><b>Paper Wrapping</b> (+0.02 AED/straw)</div>`;
        if(wrapDisabled) wrapLbl.style.opacity='.5';

        const logoLbl = document.createElement('label');
        const allowLogoNow = !logoHard && logoAllowed(p,color);
        logoLbl.innerHTML = `<input type="checkbox" ${(allowLogoNow?'':'disabled')} ${st.logo?'checked':''}> <div><b>Custom Logo</b> (+0.01 AED/straw)</div>`;
        if(logoHard || !allowLogoNow) logoLbl.style.opacity='.5';

        opt.append(wrapLbl, logoLbl);
        sub.appendChild(opt);

        const warn = document.createElement('div'); warn.className='o-warn';
        const setWarn = ()=>{
          if(p.lengthMM===150){
            warn.textContent = 'Paper Wrapping & Custom Logo not available for 150 mm.';
            warn.style.display='block';
          } else {
            const {rem, palletsApprox} = logoRemaining(p,color);
            if(rem>0){ warn.textContent = `Remaining ${rem} box(es) (~${palletsApprox} pallets) to qualify for Custom Logo.`; warn.style.display='block'; }
            else { warn.textContent=''; warn.style.display='none'; }
          }
        };
        setWarn();
        sub.appendChild(warn);

        const rowB = document.createElement('div'); rowB.className='qtyrow';
        const labB = document.createElement('div'); labB.className='qtylabel'; labB.textContent='Quantity (boxes)';
        const stepB = makeStepper(st.boxes,(delta,reflect)=>{
          st.boxes = clamp(st.boxes + delta, 0, 999);
          syncFromBoxes(p,color);
          reflect(st.boxes);
          stepP.set(st.pallets);
          updateCardActive(p.id); refreshTotals(); renderSummary();
          const allow = !logoHard && logoAllowed(p,color);
          const logoInput = logoLbl.querySelector('input');
          logoInput.disabled = !allow; logoLbl.style.opacity = allow ? '1' : '.5';
          setWarn();
        });
        rowB.append(labB, stepB.el);

        const rowP = document.createElement('div'); rowP.className='qtyrow';
        const labP = document.createElement('div'); labP.className='qtylabel'; labP.textContent='Quantity (pallets)';
        const stepP = makeStepper(st.pallets,(delta,reflect)=>{
          st.pallets = st.pallets + delta;
          syncFromPallets(p,color);
          reflect(st.pallets);
          stepB.set(st.boxes);
          updateCardActive(p.id); refreshTotals(); renderSummary();
          const allow = !logoHard && logoAllowed(p,color);
          const logoInput = logoLbl.querySelector('input');
          logoInput.disabled = !allow; logoLbl.style.opacity = allow ? '1' : '.5';
          setWarn();
        });
        rowP.append(labP, stepP.el);

        sub.append(rowB, rowP);

        // Wire options
        const wrapInput = wrapLbl.querySelector('input');
        const logoInput = logoLbl.querySelector('input');
        wrapInput.addEventListener('change', e=>{ st.wrap=!!e.target.checked; refreshTotals(); renderSummary(); });
        logoInput.addEventListener('change', e=>{ st.logo=!!e.target.checked; refreshTotals(); renderSummary(); });

        card.appendChild(sub);
      });

      grid.appendChild(card);
      updateCardActive(p.id);
    });
  }

  function updateCardActive(pid){
    const el = container.querySelector(`.o-card[data-pid="${pid}"]`);
    if(!el) return;
    const any = COLORS.some(c=>cart[pid][c].boxes>0 || cart[pid][c].pallets>0);
    el.classList.toggle('active', any);
  }

  function refreshTotals(){
    const t = totals();
    container.querySelector('#subtotal').textContent = fmtAED(Math.round(t.sum));
    container.querySelector('#items').textContent = t.boxes.toLocaleString();
    container.querySelector('#total').textContent = fmtAED(Math.round(t.sum));
  }

  /* =========== ORDER SUMMARY (SIDEBAR) =========== */
  function buildLineObjects(){
    const out=[];
    PRODUCTS.forEach(p=>COLORS.forEach(c=>{
      const st = cart[p.id][c]; if(!st.boxes && !st.pallets) return;
      const wrapAvail = p.lengthMM!==150;
      const canLogo = wrapAvail && logoAllowed(p,c);
      out.push({
        title:p.title, color:c, boxes:st.boxes, pallets:st.pallets, price:p.priceAED,
        wrap: wrapAvail ? (st.wrap?'Yes':'No') : 'N/A',
        logo: wrapAvail ? (st.logo ? (canLogo?'Yes':'No (below MOQ)') : 'No') : 'N/A'
      });
    }));
    return out;
  }

  function renderSummary(){
    const list = container.querySelector('#sumList');
    const lines = buildLineObjects();
    list.innerHTML = '';
    if(lines.length===0){
      list.innerHTML = '<li class="sum-item" style="border-bottom:0;color:#6b778c">No items yet.</li>';
      return;
    }
    lines.forEach(L=>{
      const li = document.createElement('li'); li.className='sum-item';
      li.innerHTML = `
        <div style="flex:1 1 auto;min-width:0">
          <div style="font-weight:800">${L.title} <span class="sum-chip">${L.color}</span></div>
          <div class="o-muted">Boxes: <b>${L.boxes}</b> • Pallets: <b>${L.pallets}</b> • Price: <b>AED ${L.price}/box</b></div>
          <div class="o-muted">Wrap: <b>${L.wrap}</b> • Logo: <b>${L.logo}</b></div>
        </div>
      `;
      list.appendChild(li);
    });
  }

  /* ================== SUBMIT ================== */
  function buildLinesText(){
    return buildLineObjects().map(L=>`${L.title} — ${L.color}: ${L.boxes} box(es) (${L.pallets} pallet(s)), AED ${L.price}/box, Wrap: ${L.wrap}, Logo: ${L.logo}`);
  }

  function payload(){
    const t = totals();
    const f = id => container.querySelector('#'+id)?.value?.trim() || '';
    const diff = !!container.querySelector('#f_diff')?.checked;

    // Build email subject + summary
    const lineStrings = buildLinesText();
    const subjectName = f('f_company') || f('f_name') || 'New UAE Wholesale Order';
    const email_subject = `UAE Wholesale Order — ${subjectName} — ${t.boxes} box(es), ${fmtAED(Math.round(t.sum))}`;
    const email_summary = [
      `Customer: ${f('f_name')} (${f('f_email')})`,
      f('f_company') ? `Company: ${f('f_company')}` : null,
      `Shipping: ${f('f_shipping') || 'pickup'}`,
      `Subtotal: ${fmtAED(Math.round(t.sum))}`,
      `Items (boxes): ${t.boxes}`,
      'Lines:',
      ...lineStrings.map(s => '• ' + s)
    ].filter(Boolean).join('\n');

    return {
      source:'UAE Wholesale Order Portal',
      email_subject,
      email_summary,
      items_boxes: t.boxes,
      subtotal_aed: Math.round(t.sum),
      shipping: f('f_shipping'),
      customer:{
        name:f('f_name'), email:f('f_email'), whatsapp:f('f_whatsapp'),
        company:f('f_company'), address:f('f_address'), district:f('f_district'),
        message:f('f_msg')
      },
      deliver_to_different: diff ? {
        name:f('d_name'), phone:f('d_phone'), company:f('d_company'),
        address:f('d_address'), district:f('d_district')
      } : null,
      lines: lineStrings,
      cart
    };
  }

  async function submitOrder(){
    const err = container.querySelector('#formErr');
    const ok  = container.querySelector('#sentOk');
    err.style.display='none'; ok.style.display='none';

    const p = payload();
    if(!p.customer.name || !p.customer.email){
      err.textContent='Please fill in name and email.'; err.style.display='block'; return;
    }
    if(p.items_boxes<=0){
      err.textContent='Please add at least 1 box to your order.'; err.style.display='block'; return;
    }

    try{
      const r = await fetch(WEBHOOK_URL,{
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          // Some endpoints require this to avoid CORS preflight issues; harmless if ignored:
          'Accept':'application/json, text/plain, */*'
        },
        body:JSON.stringify(p)
      });
      if(!r.ok) throw new Error('HTTP '+r.status);
      ok.style.display='inline-block';
    }catch(e){
      err.textContent='Could not submit order. Please try again.'; err.style.display='block';
    }
  }

  /* ================== INIT ================== */
  root.appendChild(style);
  root.appendChild(container);

  renderProducts();
  refreshTotals();
  renderSummary();

  container.querySelector('#submitBtn').addEventListener('click', submitOrder);
  container.querySelector('#f_diff').addEventListener('change', (e)=>{
    container.querySelector('#diffWrap').classList.toggle('o-hidden', !e.target.checked);
  });
})();
</script>
{% endraw %}
